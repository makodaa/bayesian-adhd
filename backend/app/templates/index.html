<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BayesianADHD - EEG Analysis Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous" />
    <style>
        :root {
            --primary-color: #5a6c7d;
            --secondary-color: #6c9bd1;
            --accent-color: #e89a9c;
            --success-color: #81c995;
            --warning-color: #f5c26b;
            --bg-light: #f5f7fa;
            --text-dark: #4a5568;
            --border-color: #d1d5db;
            --sidebar-width: 250px;
            --sidebar-collapsed-width: 60px;
        }

        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow: hidden;
        }

        .navbar {
            background: linear-gradient(135deg, #8fa5b8, #a8c5e4);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 0 1rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 70px;
            display: flex;
            align-items: center;
        }

        .navbar-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .navbar-brand {
            font-size: 1.25rem;
            font-weight: 600;
            color: white !important;
            margin: 0;
        }

        .navbar-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
            padding: 0.5rem;
            margin: 0;
            line-height: 1;
            transition: opacity 0.2s;
        }

        .navbar-toggle:hover {
            opacity: 0.8;
        }

        .layout-wrapper {
            display: flex;
            height: 100vh;
            margin-top: 70px;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            transition: width 0.3s ease;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 70px);
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }

        .sidebar-nav {
            flex: 1;
            padding: 1.5rem 0;
        }

        .nav-item {
            list-style: none;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.875rem 1rem;
            color: var(--primary-color);
            text-decoration: none;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .nav-link:hover {
            background: #f8f9fa;
        }

        .nav-link.active {
            background: #e9ecef;
            border-right: 3px solid var(--secondary-color);
            font-weight: 600;
        }

        .nav-link svg {
            min-width: 24px;
            margin-right: 1rem;
            transition: margin 0.3s ease;
        }

        .nav-link span {
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        .sidebar.collapsed .nav-link {
            justify-content: center;
            padding: 0.875rem 0;
        }

        .sidebar.collapsed .nav-link svg {
            margin-right: 0;
        }

        .sidebar.collapsed .nav-link span {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }

        .main-container {
            flex: 1;
            display: grid;
            grid-template-columns: 480px 1fr;
            gap: 1.5rem;
            padding: 1.5rem;
            height: calc(100vh - 70px);
            overflow: hidden;
        }

        .left-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            overflow-y: auto;
            height: 100%;
        }

        .right-panel {
            display: grid;
            grid-template-rows: 1fr 1fr;
            gap: 1.5rem;
            height: 100%;
            overflow: hidden;
        }

        .visualization-panel,
        .results-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            overflow-y: auto;
            min-height: 0;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e0e7ef;
        }

        .form-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 0.3rem;
        }

        .form-control,
        .form-select {
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .btn-primary {
            background-color: var(--secondary-color);
            border: none;
            padding: 0.6rem 1.5rem;
            font-weight: 500;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #5a8bc4;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-primary:disabled {
            background-color: #c5d0db;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .nav-tabs {
            border-bottom: 2px solid var(--border-color);
        }

        .nav-tabs .nav-link {
            color: var(--text-dark);
            border: none;
            border-bottom: 3px solid transparent;
            padding: 0.7rem 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link:hover:not(:disabled) {
            border-bottom-color: var(--secondary-color);
        }

        .nav-tabs .nav-link.active {
            color: var(--secondary-color);
            background: none;
            border-bottom-color: var(--secondary-color);
        }

        .nav-tabs .nav-link:disabled {
            color: #c5d0db;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .tab-content {
            padding: 1.5rem 0;
        }

        .visualization-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            background: #f8f9fa;
            border-radius: 4px;
            padding: 1rem;
        }

        .visualization-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 4px;
        }

        .metric-card {
            background: linear-gradient(135deg, #8fa5b8 0%, #a8c5e4 100%);
            color: white;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .metric-card.adhd {
            background: linear-gradient(135deg, #6a8095 0%, #62718a 100%);
        }

        .metric-card.non-adhd {
            background: linear-gradient(135deg, #8fa5b8 0%, #7a92a8 100%);
        }

        .metric-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 0.3rem;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .band-bar {
            display: flex;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .band-label {
            width: 80px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .band-progress {
            flex: 1;
            height: 24px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            margin: 0 0.8rem;
        }

        .band-progress-bar {
            height: 100%;
            transition: width 0.6s ease;
        }

        .band-value {
            width: 60px;
            text-align: right;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .ratio-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0.8rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .ratio-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .ratio-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--secondary-color);
        }

        /* Topographic Maps */
        .topo-section {
            margin-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
        }

        .topo-tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .topo-tab {
            padding: 0.35rem 0.7rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .topo-tab:hover {
            background: #e9ecef;
        }

        .topo-tab.active {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .topo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.75rem;
        }

        .topo-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
            text-align: center;
        }

        .topo-card img {
            width: 100%;
            height: auto;
            border-radius: 4px;
        }

        .topo-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            color: var(--text-dark);
        }

        .topo-type-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .topo-type-btn {
            padding: 0.4rem 0.8rem;
            border: 2px solid var(--secondary-color);
            border-radius: 20px;
            background: white;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .topo-type-btn:hover {
            background: rgba(108, 155, 209, 0.1);
        }

        .topo-type-btn.active {
            background: var(--secondary-color);
            color: white;
        }

        /* Temporal Biomarkers */
        .temporal-section {
            margin-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
        }

        .temporal-plot-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .temporal-plot-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .temporal-plot-card .plot-header {
            padding: 0.5rem 0.75rem;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .temporal-plot-card .plot-header:hover {
            background: #e9ecef;
        }

        .temporal-plot-card .plot-body {
            padding: 0.5rem;
        }

        .temporal-plot-card .plot-body img {
            width: 100%;
            height: auto;
        }

        .temporal-plot-card .plot-body.collapsed {
            display: none;
        }

        .temporal-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .temporal-stat {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 0.4rem 0.6rem;
            font-size: 0.78rem;
        }

        .temporal-stat .stat-label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.15rem;
        }

        .temporal-stat .stat-values {
            display: flex;
            gap: 0.5rem;
            color: var(--text-dark);
        }

        .temporal-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            color: var(--text-dark);
        }

        .spinner-border {
            color: var(--secondary-color);
        }

        .alert-custom {
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: block;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: 0.6rem 1rem;
            background: #f8f9fa;
            border: 2px dashed var(--border-color);
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            border-color: var(--secondary-color);
            background: #e9ecef;
        }

        .file-input-label.has-file {
            border-color: var(--success-color);
            background: #d4edda;
            color: var(--success-color);
        }

        .form-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        small.text-muted {
            font-size: 0.8rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #a0aec0;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-control[readonly],
        .form-select:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-left">
            <button class="navbar-toggle" id="sidebar-toggle">
                <span>â˜°</span>
            </button>
            <span class="navbar-brand">BayesianADHD</span>
        </div>
        <div style="margin-left: auto; display: flex; align-items: center; gap: 1rem;">
            <span style="color: white; font-weight: 500;" id="clinician-name"></span>
            <button id="logout-btn"
                style="background: rgba(255, 255, 255, 0.2); border: 1px solid white; color: white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s ease;">
                Logout
            </button>
        </div>
    </nav>

    <div class="layout-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar collapsed" id="sidebar">
            <nav class="sidebar-nav">
                <ul style="padding: 0; margin: 0;">
                    <li class="nav-item">
                        <a href="/index.html" class="nav-link active">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                            <span>Analysis</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/subjects.html" class="nav-link">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            <span>Subjects</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/clinicians.html" class="nav-link">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <span>Clinicians</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/results.html" class="nav-link">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            <span>Results</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/about.html" class="nav-link">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                            <span>About</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Container -->
        <div class="main-container">
            <!-- Left Panel: Forms -->
            <div class="left-panel">
                <form id="analysis-form" enctype="multipart/form-data">
                    <!-- Subject Demographics -->
                    <div class="form-section">
                        <h5 class="section-title">Subject Demographics</h5>
                        <div class="mb-3">
                            <label for="subject-code" class="form-label">Subject Code</label>
                            <input type="text" class="form-control" id="subject-code" placeholder="e.g., SUB001"
                                required />
                            <datalist id="subject-list">
                                <!-- Subjects will be loaded dynamically -->
                            </datalist>
                            <small class="text-muted">Select from existing subjects or enter a new code</small>
                        </div>
                        <div class="mb-3">
                            <label for="age" class="form-label">Age</label>
                            <input type="number" class="form-control" id="age" placeholder="Age in years" min="1"
                                max="120" required />
                        </div>
                        <div class="mb-3">
                            <label for="gender" class="form-label">Gender</label>
                            <select class="form-select" id="gender" required>
                                <option value="" selected disabled>
                                    Select gender
                                </option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <!-- Clinician Information -->
                    <div class="form-section">
                        <h5 class="section-title">Clinician Information</h5>
                        <div class="mb-3">
                            <label for="clinician-input" class="form-label">Clinician Name</label>
                            <input type="text" name="clinician_name" class="form-control" id="clinician-input"
                                list="clinician-list" placeholder="Clinician" readonly />
                            <datalist id="clinician-list">
                                <!-- Clinicians will be loaded dynamically -->
                            </datalist>
                        </div>
                        <div class="mb-3">
                            <label for="occupation" class="form-label">Occupation</label>
                            <input type="text" name="occupation" class="form-control" id="occupation"
                                placeholder="e.g., Neurologist" readonly />
                        </div>
                    </div>

                    <!-- Recording Environment -->
                    <div class="form-section">
                        <h5 class="section-title">Recording Environment</h5>
                        <div class="mb-3">
                            <label for="sleep-hours" class="form-label">Sleep Hours</label>
                            <input type="number" class="form-control" id="sleep-hours" placeholder="Hours of sleep"
                                min="0" max="24" step="0.5" />
                        </div>
                        <div class="mb-3">
                            <label for="food-intake" class="form-label">Food Intake</label>
                            <input type="text" class="form-control" id="food-intake" placeholder="Recent food intake" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Caffeinated</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="caffeinated" id="caffeinated-yes"
                                        value="true" />
                                    <label class="form-check-label" for="caffeinated-yes">Yes</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="caffeinated" id="caffeinated-no"
                                        value="false" />
                                    <label class="form-check-label" for="caffeinated-no">No</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Medicated</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="medicated" id="medicated-yes"
                                        value="true" />
                                    <label class="form-check-label" for="medicated-yes">Yes</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="medicated" id="medicated-no"
                                        value="false" />
                                    <label class="form-check-label" for="medicated-no">No</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="medication-intake" class="form-label">Medication Details</label>
                            <textarea class="form-control" id="medication-intake" rows="2"
                                placeholder="Medication details if applicable"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="notes" class="form-label">Additional Notes</label>
                            <textarea class="form-control" id="notes" rows="3"
                                placeholder="Any additional observations"></textarea>
                        </div>
                    </div>

                    <!-- EEG File Upload -->
                    <div class="form-section">
                        <h5 class="section-title">EEG Data Upload</h5>
                        <div class="mb-3">
                            <label class="form-label">Upload EEG Recording (.csv)</label>
                            <div class="file-input-wrapper">
                                <label class="file-input-label" id="file-label">
                                    <div>Click to select file</div>
                                    <small class="text-muted">Supported: .csv files</small>
                                </label>
                                <input type="file" name="file" id="file" accept=".csv" required />
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary w-100" id="analyze-btn" disabled>
                        Analyze EEG Recording
                    </button>
                </form>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <!-- Visualization Panel -->
                <div class="visualization-panel">
                    <h5 class="section-title">EEG Visualizations</h5>
                    <ul class="nav nav-tabs" id="eegTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="raw-tab" data-bs-toggle="tab" data-bs-target="#raw-pane"
                                type="button" role="tab" disabled>
                                Raw
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="filtered-tab" data-bs-toggle="tab"
                                data-bs-target="#filtered-pane" type="button" role="tab" disabled>
                                Filtered
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="delta-tab" data-bs-toggle="tab" data-bs-target="#delta-pane"
                                type="button" role="tab" disabled>
                                Delta
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="theta-tab" data-bs-toggle="tab" data-bs-target="#theta-pane"
                                type="button" role="tab" disabled>
                                Theta
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="alpha-tab" data-bs-toggle="tab" data-bs-target="#alpha-pane"
                                type="button" role="tab" disabled>
                                Alpha
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="beta-tab" data-bs-toggle="tab" data-bs-target="#beta-pane"
                                type="button" role="tab" disabled>
                                Beta
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="gamma-tab" data-bs-toggle="tab" data-bs-target="#gamma-pane"
                                type="button" role="tab" disabled>
                                Gamma
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="eegTabContent">
                        <div class="tab-pane fade show active" id="raw-pane" role="tabpanel">
                            <div class="visualization-container" id="viz-raw">
                                <p class="text-muted">
                                    Upload an EEG file to view visualizations
                                </p>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="filtered-pane" role="tabpanel">
                            <div class="visualization-container" id="viz-filtered">
                                <p class="text-muted">
                                    Upload an EEG file to view visualizations
                                </p>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="delta-pane" role="tabpanel">
                            <div class="visualization-container" id="viz-delta">
                                <p class="text-muted">
                                    Upload an EEG file to view visualizations
                                </p>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="theta-pane" role="tabpanel">
                            <div class="visualization-container" id="viz-theta">
                                <p class="text-muted">
                                    Upload an EEG file to view visualizations
                                </p>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="alpha-pane" role="tabpanel">
                            <div class="visualization-container" id="viz-alpha">
                                <p class="text-muted">
                                    Upload an EEG file to view visualizations
                                </p>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="beta-pane" role="tabpanel">
                            <div class="visualization-container" id="viz-beta">
                                <p class="text-muted">
                                    Upload an EEG file to view visualizations
                                </p>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="gamma-pane" role="tabpanel">
                            <div class="visualization-container" id="viz-gamma">
                                <p class="text-muted">
                                    Upload an EEG file to view visualizations
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Panel -->
                <div class="results-panel">
                    <h5 class="section-title">Analysis Results</h5>
                    <div id="results-empty-state" class="empty-state">
                        <p>
                            Analysis results will appear here after processing
                        </p>
                    </div>
                    <div id="results-content" style="display: none">
                        <!-- Model Prediction -->
                        <div id="prediction-result" class="mb-4"></div>
                        <!-- Band Powers and Ratios -->
                        <div>
                            <h6 class="mb-3" style="font-weight: 600">
                                Relative Band Power
                            </h6>
                            <div id="band-power-bars"></div>
                        </div>
                        <div class="mt-4">
                            <h6 class="mb-3" style="font-weight: 600">
                                Clinical Ratios
                            </h6>
                            <div id="clinical-ratios"></div>
                        </div>
                        <!-- Topographic Scalp Maps -->
                        <div id="topo-section" class="topo-section" style="display: none;">
                            <h6 class="mb-3" style="font-weight: 600">Spatial Analysis - Scalp Topography</h6>
                            <div class="topo-type-toggle">
                                <button class="topo-type-btn active" data-topo-type="absolute" onclick="switchTopoType('absolute')">Absolute Power</button>
                                <button class="topo-type-btn" data-topo-type="relative" onclick="switchTopoType('relative')">Relative Power</button>
                                <button class="topo-type-btn" data-topo-type="tbr" onclick="switchTopoType('tbr')">TBR</button>
                            </div>
                            <div id="topo-content">
                                <div id="topo-absolute" class="topo-grid"></div>
                                <div id="topo-relative" class="topo-grid" style="display: none;"></div>
                                <div id="topo-tbr" style="display: none;"></div>
                            </div>
                            <div id="topo-loading" class="topo-loading" style="display: none;">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2" style="font-size: 0.9rem;">Generating scalp topographic maps...</p>
                            </div>
                        </div>
                        <!-- Temporal Biomarker Evolution -->
                        <div id="temporal-section" class="temporal-section" style="display: none;">
                            <h6 class="mb-3" style="font-weight: 600">Temporal Features - Biomarker Evolution</h6>
                            <p style="font-size: 0.8rem; color: #6c757d; margin-bottom: 0.75rem;">
                                Biomarker values computed in sliding 2-second windows across the recording.
                                Click a group header to expand/collapse.
                            </p>
                            <div id="temporal-plots" class="temporal-plot-list"></div>
                            <div id="temporal-summary"></div>
                            <div id="temporal-loading" class="temporal-loading" style="display: none;">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2" style="font-size: 0.9rem;">Computing temporal biomarkers...</p>
                            </div>
                        </div>
                        <div id="analysis-disclaimers">
                            <div id="persistent-disclaimer" class="alert-custom"
                                style="background:#fff3cd;border:1px solid #ffeeba;margin-bottom:0.5rem;">
                                <strong>Important:</strong> This system does not provide a definitive diagnosis. Results
                                are for informational purposes only and must not be used as the sole basis for clinical
                                decisions.
                            </div>
                            <div id="recording-disclaimers"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Load clinician name from server session and setup logout
            document.addEventListener('DOMContentLoaded', async function () {
                try {
                    const resp = await fetch('/api/me');
                    if (!resp.ok) {
                        window.location.href = '/login.html';
                        return;
                    }
                    const me = await resp.json();
                    const clinicianName = me.clinician_name || 'Clinician';
                    const clinicianOccupation = me.clinician_occupation || '';

                    // cache for compatibility with existing code
                    sessionStorage.setItem('clinician_name', clinicianName);
                    sessionStorage.setItem('clinician_occupation', clinicianOccupation);

                    // navbar display
                    const navName = document.getElementById('clinician-name');
                    if (navName) navName.textContent = clinicianName;

                    // form inputs (read-only)
                    const clinicianInput = document.getElementById('clinician-input');
                    if (clinicianInput) {
                        clinicianInput.value = clinicianName;
                    }
                    const occupationInput = document.getElementById('occupation');
                    if (occupationInput) {
                        occupationInput.value = clinicianOccupation;
                    }

                    // Setup logout button
                    const logoutBtn = document.getElementById('logout-btn');
                    if (logoutBtn) {
                        logoutBtn.addEventListener('click', async function () {
                            try {
                                const response = await fetch('/api/logout', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' }
                                });

                                if (response.ok) {
                                    sessionStorage.clear();
                                    window.location.href = '/login.html';
                                } else {
                                    window.location.href = '/login.html';
                                }
                            } catch (error) {
                                console.error('Error during logout:', error);
                                window.location.href = '/login.html';
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error fetching current clinician:', error);
                    window.location.href = '/login.html';
                }
            });

            // Sidebar toggle
            document.getElementById('sidebar-toggle').addEventListener('click', function () {
                document.getElementById('sidebar').classList.toggle('collapsed');
            });

            async function loadSubjects() {
                try {
                    const response = await fetch('/api/subjects');
                    const subjects = await response.json();

                    const datalist = document.getElementById('subject-list');
                    subjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject.subject_code;
                        option.setAttribute('data-age', subject.age);
                        option.setAttribute('data-gender', subject.gender);
                        datalist.appendChild(option);
                    });

                    console.log(`Loaded ${subjects.length} subjects`);
                } catch (error) {
                    console.error('Error loading subjects:', error);
                }
            }

            // Auto-fill age and gender when subject is selected
            document.getElementById('subject-code').addEventListener('input', function (e) {
                const selectedCode = e.target.value;
                const datalist = document.getElementById('subject-list');
                const options = datalist.querySelectorAll('option');

                let found = false;
                options.forEach(option => {
                    if (option.value === selectedCode) {
                        const age = option.getAttribute('data-age');
                        const gender = option.getAttribute('data-gender');
                        if (age) {
                            document.getElementById('age').value = age;
                            document.getElementById('age').readOnly = true;
                        }
                        if (gender) {
                            document.getElementById('gender').value = gender;
                            document.getElementById('gender').disabled = true;
                        }
                        found = true;
                    }
                });

                // If not found in list, make age and gender editable
                if (!found) {
                    document.getElementById('age').readOnly = false;
                    document.getElementById('gender').disabled = false;
                }
            });

            // Load clinicians for datalist
            async function loadClinicians() {
                try {
                    const response = await fetch('/api/clinicians');
                    const clinicians = await response.json();

                    const datalist = document.getElementById('clinician-list');
                    clinicians.forEach(clinician => {
                        const option = document.createElement('option');
                        option.value = clinician.name;
                        option.setAttribute('data-occupation', clinician.occupation);
                        datalist.appendChild(option);
                    });

                    console.log(`Loaded ${clinicians.length} clinicians`);
                } catch (error) {
                    console.error('Error loading clinicians:', error);
                    // Fallback to placeholder data if API fails
                    const clinicians = [
                        { id: 1, name: "Dr. Sarah Johnson", occupation: "Neurologist" },
                        { id: 2, name: "Dr. Michael Chen", occupation: "Psychiatrist" },
                        { id: 3, name: "Dr. Emily Rodriguez", occupation: "Clinical Psychologist" },
                    ];

                    const datalist = document.getElementById('clinician-list');
                    clinicians.forEach(clinician => {
                        const option = document.createElement('option');
                        option.value = clinician.name;
                        option.setAttribute('data-occupation', clinician.occupation);
                        datalist.appendChild(option);
                    });
                }
            }

            // Auto-fill occupation when clinician is selected
            document.getElementById('clinician-name').addEventListener('input', function (e) {
                const selectedName = e.target.value;
                const datalist = document.getElementById('clinician-list');
                const options = datalist.querySelectorAll('option');

                let found = false;
                options.forEach(option => {
                    if (option.value === selectedName) {
                        const occupation = option.getAttribute('data-occupation');
                        if (occupation) {
                            document.getElementById('occupation').value = occupation;
                            document.getElementById('occupation').readOnly = true;
                            found = true;
                        }
                    }
                });

                // If not found in list, make occupation editable
                if (!found) {
                    document.getElementById('occupation').readOnly = false;
                }
            });

            // Initialize
            loadSubjects();
            loadClinicians();
        </script>

        <script>
            // Attach password visibility toggles to any password inputs on the page
            (function attachPasswordToggles() {
                const pwdInputs = document.querySelectorAll('input[type="password"]');
                pwdInputs.forEach((input) => {
                    // don't add duplicate toggles
                    if (input.dataset.hasToggle) return;
                    input.dataset.hasToggle = '1';

                    const wrapper = document.createElement('div');
                    wrapper.style.position = 'relative';

                    // Insert wrapper before input
                    input.parentNode.insertBefore(wrapper, input);
                    wrapper.appendChild(input);

                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.setAttribute('aria-label', 'Show password');
                    btn.style.position = 'absolute';
                    btn.style.right = '8px';
                    btn.style.top = '50%';
                    btn.style.transform = 'translateY(-50%)';
                    btn.style.background = 'none';
                    btn.style.border = 'none';
                    btn.style.padding = '4px';
                    btn.style.cursor = 'pointer';

                    btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';

                    btn.addEventListener('click', function () {
                        if (input.type === 'password') {
                            input.type = 'text';
                            btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8a21.86 21.86 0 0 1 5.06-6.06"/><path d="M1 1l22 22"/></svg>';
                        } else {
                            input.type = 'password';
                            btn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>';
                        }
                    });

                    wrapper.appendChild(btn);
                });
            })();
        </script>

        <script>
            // State management
            let analysisData = {
                file: null,
                visualizations: {},
                results: null,
            };

            // Band colors
            const bandColors = {
                delta: "#9C27B0",
                theta: "#2196F3",
                alpha: "#4CAF50",
                beta: "#FF9800",
                gamma: "#F44336",
                fast_alpha: "#3F51B5",
                high_beta: "#00BCD4",
            };

            // UI Helper Functions
            function showElement(id) {
                const elem = document.getElementById(id);
                if (elem) elem.style.display = "block";
            }

            function hideElement(id) {
                const elem = document.getElementById(id);
                if (elem) elem.style.display = "none";
            }

            function setLoadingState(containerId, isLoading) {
                const container = document.getElementById(containerId);
                if (!container) return;

                if (isLoading) {
                    container.innerHTML = `
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    `;
                }
            }

            function displayVisualization(containerId, imageData) {
                const container = document.getElementById(containerId);
                if (!container) return;

                // Check if imageData is an array of images or a single image
                if (Array.isArray(imageData)) {
                    // Stitch multiple images vertically
                    const imagesHtml = imageData.map(img => 
                        `<img src="${img}" alt="EEG Visualization" style="display: block; width: 100%; margin: 0; padding: 0;" />`
                    ).join('');
                    container.innerHTML = `<div style="display: flex; flex-direction: column;">${imagesHtml}</div>`;
                } else {
                    // Single image (backward compatibility)
                    container.innerHTML = `<img src="${imageData}" alt="EEG Visualization" />`;
                }
            }

            // File input handler
            document
                .getElementById("file")
                .addEventListener("change", function (e) {
                    const file = e.target.files[0];
                    const label = document.getElementById("file-label");
                    const analyzeBtn = document.getElementById("analyze-btn");

                    if (file) {
                        analysisData.file = file;
                        label.classList.add("has-file");
                        label.innerHTML = `
                        <div style="font-weight: 600;">${file.name}</div>
                        <small class="text-muted">${(file.size / 1024).toFixed(
                            2
                        )} KB</small>
                    `;
                        analyzeBtn.disabled = false;
                    } else {
                        analysisData.file = null;
                        label.classList.remove("has-file");
                        label.innerHTML = `
                        <div>Click to select file</div>
                        <small class="text-muted">Supported: .csv files</small>
                    `;
                        analyzeBtn.disabled = true;
                    }
                });

            // Enable/disable tabs
            function setTabsEnabled(enabled) {
                const tabs = [
                    "raw-tab",
                    "filtered-tab",
                    "delta-tab",
                    "theta-tab",
                    "alpha-tab",
                    "beta-tab",
                    "gamma-tab",
                ];
                tabs.forEach((tabId) => {
                    const tab = document.getElementById(tabId);
                    if (tab) {
                        tab.disabled = !enabled;
                    }
                });
            }

            // Load all visualizations
            async function loadVisualizations(formData) {
                const bands = [
                    "raw",
                    "filtered",
                    "delta",
                    "theta",
                    "alpha",
                    "beta",
                    "gamma",
                ];

                // Enable tabs
                setTabsEnabled(true);

                // Load each visualization by loading them all at the same time.
                try {
                    for (const band of bands) {
                        const containerId = `viz-${band}`;
                        setLoadingState(containerId, true);
                    }

                    const response = await fetch(
                        `/visualize_all_eeg`, {
                            method: "POST",
                            body: formData,
                        },
                    );

                    console.log(`Response received: ${response}`);
                    const json = await response.json();
                    const {result: visualizations} = json;
                    for (const {band, images} of visualizations) {
                        console.warn(`Visualization for ${band} loaded successfully.`);
                        if (!bands.includes(band)) {
                        console.error(`Visualization for ${band} is not supported. What hafen, vella?`);
                        continue;
                        }

                        const containerId = `viz-${band}`;
                        displayVisualization(containerId, images);
                        analysisData.visualizations[band] = images;
                    }
                } catch (error) {
                    console.error(`Error loading visualizations:`, error);
                }
            }

            // Display prediction results
            function displayPrediction(classification, confidenceScore) {
                const container = document.getElementById("prediction-result");
                const isADHD = classification === "ADHD";
                const cardClass = isADHD ? "adhd" : "non-adhd";

                container.innerHTML = `
                    <div class="metric-card ${cardClass}">
                        <div class="metric-label">Model Prediction</div>
                        <div class="metric-value">${classification}</div>
                        <div style="margin-top: 0.5rem; font-size: 1rem;">
                            Confidence: ${(confidenceScore * 100).toFixed(2)}%
                        </div>
                    </div>
                `;
            }

            // Display band power analysis
            function displayBandPowers(bandData) {
                const barsContainer = document.getElementById("band-power-bars");
                console.log('Band data:', bandData);

                // Use display_bands if available (filtered for frontend), otherwise fall back to full data
                const displayData = bandData.display_bands || bandData;

                // Check if bandData and average_relative_power exist
                if (!displayData || !displayData.average_relative_power) {
                    console.warn('No band power data available');
                    barsContainer.innerHTML = '<p class="text-muted">Band power data not available</p>';
                    return;
                }

                const bands = Object.keys(displayData.average_relative_power);
                if (bands.length === 0) {
                    barsContainer.innerHTML = '<p class="text-muted">No band power data available</p>';
                    return;
                }

                // Normative values for comparison (in percentages)
                const normativeRanges = {
                    'delta': '15 - 30%',
                    'theta': '15 - 25%',
                    'alpha': '25 - 35%',
                    'fast_alpha': '4 - 7%',
                    'beta': '10 - 15%',
                    'high_beta': '3 - 5%',
                    'gamma': '5 - 10%'
                };

                let html = "";
                bands.forEach((band) => {
                    const percentage = (displayData.average_relative_power[band] * 100).toFixed(1);
                    const normative = normativeRanges[band.toLowerCase()]
                                    || normativeRanges[band]
                                    || 'N/A';

                    const bandDisplay = band[0].toUpperCase() + band.slice(1);
                    html += `
                        <div class="band-bar">
                            <div class="band-label">${bandDisplay}</div>
                            <div class="band-progress">
                                <div class="band-progress-bar"
                                     style="width: ${percentage}%; background-color: ${bandColors[band]};">
                                </div>
                            </div>
                            <div class="band-value">${percentage}%</div>
                        </div>
                        <div style="font-size: 0.8rem; color: #6c757d; margin-bottom: 1rem; margin-left: 80px;">
                            Normal range: ${normative}
                        </div>
                    `;
                });

                barsContainer.innerHTML = html;
            }

            // Display clinical ratios
            function displayClinicalRatios(ratios) {
                const container = document.getElementById("clinical-ratios");

                // Check if ratios exist
                if (!ratios || Object.keys(ratios).length === 0) {
                    console.warn('No clinical ratios data available');
                    container.innerHTML = '<p class="text-muted">Clinical ratios not available</p>';
                    return;
                }

                let html = "";
                Object.entries(ratios).forEach(([name, value]) => {
                    const displayName = name
                        .replace(/_/g, " ")
                        .replace(/\b\w/g, (l) => l.toUpperCase());
                    html += `
                        <div class="ratio-item">
                            <span class="ratio-name">${displayName}</span>
                            <span class="ratio-value">${value.toFixed(3)}</span>
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            // Main form submission handler
            document
                .getElementById("analysis-form")
                .addEventListener("submit", async function (e) {
                    e.preventDefault();

                    const analyzeBtn = document.getElementById("analyze-btn");
                    analyzeBtn.disabled = true;
                    analyzeBtn.innerHTML =
                        '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

                    // Prepare form data with all fields
                    const formData = new FormData();
                    formData.append("file", analysisData.file);

                    // Subject demographics
                    formData.append("subject_code", document.getElementById("subject-code").value);
                    formData.append("age", document.getElementById("age").value);
                    formData.append("gender", document.getElementById("gender").value);

                    // Clinician information
                    formData.append("clinician_name", document.getElementById("clinician-name").value);
                    formData.append("occupation", document.getElementById("occupation").value);

                    // Recording environment
                    const sleepHours = document.getElementById("sleep-hours").value;
                    if (sleepHours) formData.append("sleep_hours", sleepHours);

                    const foodIntake = document.getElementById("food-intake").value;
                    if (foodIntake) formData.append("food_intake", foodIntake);

                    const caffeinated = document.querySelector('input[name="caffeinated"]:checked');
                    if (caffeinated) formData.append("caffeinated", caffeinated.value);

                    const medicated = document.querySelector('input[name="medicated"]:checked');
                    if (medicated) formData.append("medicated", medicated.value);

                    const medicationIntake = document.getElementById("medication-intake").value;
                    if (medicationIntake) formData.append("medication_intake", medicationIntake);

                    const notes = document.getElementById("notes").value;
                    if (notes) formData.append("notes", notes);

                    // Create separate FormData for visualizations (file only)
                    const vizFormData = new FormData();
                    vizFormData.append("file", analysisData.file);

                    try {
                        // Load visualizations in parallel with prediction (which now includes band analysis)
                        const predictionPromise = await fetch("/predict", {
                            method: "POST",
                            body: formData,
                        });

                        // Process prediction (now includes band analysis)
                        const predictionData = await predictionPromise.json();
                        if (predictionData.error) {
                            alert("Error: " + predictionData.error);
                            return;
                        }

                        // Show results panel
                        hideElement("results-empty-state");
                        showElement("results-content");

                        // Display results
                        const result = predictionData.result || predictionData;
                        displayPrediction(
                            result.classification ||
                            (result > 0 ? "ADHD" : "Non-ADHD"),
                            result.confidence_score || Math.abs(result)
                        );

                        // Band analysis is now included in the prediction response
                        const bandData = result.band_analysis || {};
                        console.log(result);
                        displayBandPowers(bandData);
                        displayClinicalRatios(bandData.band_ratios || {});

                        // Display disclaimers based on recording conditions
                        const recordingDisclaimers = document.getElementById("recording-disclaimers");
                        let disclaimers = [];

                        const sleepNum = sleepHours ? Number(sleepHours) : null;
                        const isCaffeinated = caffeinated && caffeinated.value === "true";
                        const isMedicated = medicated && medicated.value === "true";

                        if (sleepNum !== null && !isNaN(sleepNum) && sleepNum < 4) {
                            disclaimers.push("The subject has less than 4 hours of sleep which can affect EEG recordings and may affect results.");
                        }
                        if (isCaffeinated) {
                            disclaimers.push("The subject has recent caffeine intake which can alter EEG recordings and may affect analysis.");
                        }
                        if (isMedicated) {
                            disclaimers.push("The subject is medicated which can impact EEG recordings and may affect analysis.");
                        }

                        // Only show recording notes if there are specific disclaimers
                        if (disclaimers.length > 0) {
                            let html = `<div class="alert-custom" style="background:#fff3cd;border:1px solid #ffeeba;">`;
                            html += `<strong>Recording notes:</strong><ul style="margin:0.5rem 0 0 1rem;padding:0">`;
                            disclaimers.forEach(msg => {
                                html += `<li style="margin:0.25rem 0">${msg}</li>`;
                            });
                            html += `</ul></div>`;
                            recordingDisclaimers.innerHTML = html;
                        } else {
                            recordingDisclaimers.innerHTML = '';
                        }

                        // Store results
                        analysisData.results = {
                            prediction: result,
                            bands: bandData,
                        };

                        loadVisualizations(vizFormData);

                        // Load topographic maps in parallel using the file
                        loadTopographicMaps(vizFormData);

                        // Load temporal biomarker evolution
                        const temporalFormData = new FormData();
                        temporalFormData.append("file", analysisData.file);
                        loadTemporalBiomarkers(temporalFormData);
                    } catch (error) {
                        console.error("Analysis error:", error);
                        alert(
                            "An error occurred during analysis. Please try again."
                        );
                    } finally {
                        analyzeBtn.disabled = false;
                        analyzeBtn.innerHTML = "Analyze EEG Recording";
                    }
                });
        </script>

        <script>
            // â”€â”€ Topographic Maps â”€â”€

            let currentTopoData = null;

            async function loadTopographicMaps(formData) {
                const section = document.getElementById('topo-section');
                const loading = document.getElementById('topo-loading');
                const absGrid = document.getElementById('topo-absolute');
                const relGrid = document.getElementById('topo-relative');
                const tbrDiv = document.getElementById('topo-tbr');

                // Show section with loading state
                section.style.display = '';
                loading.style.display = '';
                absGrid.innerHTML = '';
                relGrid.innerHTML = '';
                tbrDiv.innerHTML = '';

                try {
                    const response = await fetch('/api/topographic_maps', {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'Failed to generate topographic maps');
                    }

                    const data = await response.json();
                    currentTopoData = data;
                    renderTopographicMaps(data);
                } catch (error) {
                    console.error('Error loading topographic maps:', error);
                    absGrid.innerHTML = `<p class="text-muted">Failed to load topographic maps: ${error.message}</p>`;
                } finally {
                    loading.style.display = 'none';
                }
            }

            async function loadTopographicMapsByResult(resultId) {
                const section = document.getElementById('topo-section');
                const loading = document.getElementById('topo-loading');
                const absGrid = document.getElementById('topo-absolute');
                const relGrid = document.getElementById('topo-relative');
                const tbrDiv = document.getElementById('topo-tbr');

                section.style.display = '';
                loading.style.display = '';
                absGrid.innerHTML = '';
                relGrid.innerHTML = '';
                tbrDiv.innerHTML = '';

                try {
                    const response = await fetch(`/api/topographic_maps/${resultId}`);

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'Failed to generate topographic maps');
                    }

                    const data = await response.json();
                    currentTopoData = data;
                    renderTopographicMaps(data);
                } catch (error) {
                    console.error('Error loading topographic maps:', error);
                    absGrid.innerHTML = `<p class="text-muted">Failed to load topographic maps: ${error.message}</p>`;
                } finally {
                    loading.style.display = 'none';
                }
            }

            function renderTopographicMaps(data) {
                const absGrid = document.getElementById('topo-absolute');
                const relGrid = document.getElementById('topo-relative');
                const tbrDiv = document.getElementById('topo-tbr');

                const bandOrder = ['delta', 'theta', 'alpha', 'beta', 'gamma'];

                // Absolute power maps
                let absHtml = '';
                bandOrder.forEach(band => {
                    const img = data.absolute_power_maps[band];
                    if (img) {
                        absHtml += `
                            <div class="topo-card">
                                <img src="${img}" alt="${band} absolute power topomap" loading="lazy" />
                            </div>`;
                    }
                });
                absGrid.innerHTML = absHtml || '<p class="text-muted">No absolute power maps available</p>';

                // Relative power maps
                let relHtml = '';
                bandOrder.forEach(band => {
                    const img = data.relative_power_maps[band];
                    if (img) {
                        relHtml += `
                            <div class="topo-card">
                                <img src="${img}" alt="${band} relative power topomap" loading="lazy" />
                            </div>`;
                    }
                });
                relGrid.innerHTML = relHtml || '<p class="text-muted">No relative power maps available</p>';

                // TBR map
                if (data.tbr_map) {
                    tbrDiv.innerHTML = `
                        <div class="topo-grid" style="max-width: 320px;">
                            <div class="topo-card">
                                <img src="${data.tbr_map}" alt="TBR topomap" loading="lazy" />
                            </div>
                        </div>`;
                } else {
                    tbrDiv.innerHTML = '<p class="text-muted">TBR map not available</p>';
                }
            }

            function switchTopoType(type) {
                const types = ['absolute', 'relative', 'tbr'];
                types.forEach(t => {
                    const el = document.getElementById(`topo-${t}`);
                    const btn = document.querySelector(`[data-topo-type="${t}"]`);
                    if (t === type) {
                        el.style.display = '';
                        btn.classList.add('active');
                    } else {
                        el.style.display = 'none';
                        btn.classList.remove('active');
                    }
                });
            }
        </script>

        <script>
            // â”€â”€ Temporal Biomarkers â”€â”€

            async function loadTemporalBiomarkers(formData) {
                const section = document.getElementById('temporal-section');
                const loading = document.getElementById('temporal-loading');
                const plotsContainer = document.getElementById('temporal-plots');
                const summaryContainer = document.getElementById('temporal-summary');

                section.style.display = '';
                loading.style.display = '';
                plotsContainer.innerHTML = '';
                summaryContainer.innerHTML = '';

                try {
                    const response = await fetch('/api/temporal_biomarkers', {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || 'Failed to compute temporal biomarkers');
                    }

                    const data = await response.json();
                    renderTemporalPlots(data.plots, plotsContainer);
                    renderTemporalSummary(data.summary, summaryContainer);
                } catch (error) {
                    console.error('Error loading temporal biomarkers:', error);
                    plotsContainer.innerHTML = `<p class="text-muted">Failed to load temporal biomarkers: ${error.message}</p>`;
                } finally {
                    loading.style.display = 'none';
                }
            }

            function renderTemporalPlots(plots, container) {
                let html = '';
                plots.forEach((plot, index) => {
                    const collapsed = index > 0 ? 'collapsed' : '';
                    const chevron = index > 0 ? '&#9654;' : '&#9660;';
                    html += `
                        <div class="temporal-plot-card">
                            <div class="plot-header" onclick="toggleTemporalPlot(this)">
                                <span>${plot.group}</span>
                                <span class="chevron">${chevron}</span>
                            </div>
                            <div class="plot-body ${collapsed}">
                                <img src="${plot.image}" alt="${plot.group} temporal evolution" loading="lazy" />
                            </div>
                        </div>`;
                });
                container.innerHTML = html || '<p class="text-muted">No temporal plots available</p>';
            }

            function toggleTemporalPlot(header) {
                const body = header.nextElementSibling;
                const chevron = header.querySelector('.chevron');
                if (body.classList.contains('collapsed')) {
                    body.classList.remove('collapsed');
                    chevron.innerHTML = '&#9660;';
                } else {
                    body.classList.add('collapsed');
                    chevron.innerHTML = '&#9654;';
                }
            }

            const biomarkerLabels = {
                theta_beta_ratio: 'Theta/Beta',
                theta_alpha_ratio: 'Theta/Alpha',
                alpha_theta_ratio: 'Alpha/Theta',
                alpha_beta_ratio: 'Alpha/Beta',
                delta_theta_ratio: 'Delta/Theta',
                low_beta_high_beta_ratio: 'Low Beta/High Beta',
                combined_ratio: 'Combined (T+B)/(A+G)',
                relative_delta: 'Relative Delta',
                relative_theta: 'Relative Theta',
                relative_alpha: 'Relative Alpha',
                relative_beta: 'Relative Beta',
                relative_gamma: 'Relative Gamma',
            };

            function renderTemporalSummary(summary, container) {
                if (!summary || Object.keys(summary).length === 0) {
                    container.innerHTML = '';
                    return;
                }

                let html = '<h6 style="font-weight:600; margin-top:1rem;">Biomarker Summary Statistics</h6>';
                html += '<div class="temporal-summary-grid">';

                Object.entries(summary).forEach(([key, stats]) => {
                    const label = biomarkerLabels[key] || key;
                    html += `
                        <div class="temporal-stat">
                            <div class="stat-label">${label}</div>
                            <div class="stat-values">
                                <span title="Mean">&mu;=${stats.mean.toFixed(3)}</span>
                                <span title="Std Dev">&sigma;=${stats.std.toFixed(3)}</span>
                            </div>
                        </div>`;
                });

                html += '</div>';
                container.innerHTML = html;
            }
        </script>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
            crossorigin="anonymous"></script>
</body>

</html>
