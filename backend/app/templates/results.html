<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Results Management - BayesianADHD</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
    <style>
      :root {
        --primary-color: #5a6c7d;
        --secondary-color: #6c9bd1;
        --sidebar-width: 250px;
        --sidebar-collapsed-width: 60px;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f5f7fa;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }

      .navbar {
        background: linear-gradient(135deg, #8fa5b8, #a8c5e4);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        padding: 0 1rem;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        height: 70px;
        display: flex;
        align-items: center;
      }

      .navbar-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .navbar-brand {
        font-size: 1.25rem;
        font-weight: 600;
        color: white !important;
        margin: 0;
      }

      .navbar-toggle {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: white;
        padding: 0.5rem;
        margin: 0;
        line-height: 1;
        transition: opacity 0.2s;
      }

      .navbar-toggle:hover {
        opacity: 0.8;
      }

      .layout-wrapper {
        display: flex;
        height: calc(100vh - 70px);
        margin-top: 70px;
        width: 100%;
      }

      .sidebar {
        width: var(--sidebar-width);
        min-width: var(--sidebar-width);
        background: white;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        overflow-y: auto;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
      }

      .sidebar.collapsed {
        width: var(--sidebar-collapsed-width);
        min-width: var(--sidebar-collapsed-width);
      }

      .sidebar-nav {
        flex: 1;
        padding: 1.5rem 0;
      }

      .nav-item {
        list-style: none;
      }

      .nav-link {
        display: flex;
        align-items: center;
        padding: 0.875rem 1rem;
        color: var(--primary-color);
        text-decoration: none;
        transition: all 0.3s ease;
        white-space: nowrap;
        font-size: 0.95rem;
        font-weight: 500;
      }

      .nav-link:hover {
        background: #f8f9fa;
      }

      .nav-link.active {
        background: #e9ecef;
        border-right: 3px solid var(--secondary-color);
        font-weight: 600;
      }

      .nav-link svg {
        min-width: 24px;
        margin-right: 1rem;
        transition: margin 0.3s ease;
      }

      .nav-link span {
        opacity: 1;
        transition: opacity 0.2s ease;
      }

      .sidebar.collapsed .nav-link {
        justify-content: center;
        padding: 0.875rem 0;
      }

      .sidebar.collapsed .nav-link svg {
        margin-right: 0;
      }

      .sidebar.collapsed .nav-link span {
        opacity: 0;
        width: 0;
        overflow: hidden;
      }

      .main-content {
        flex: 1;
        padding: 2rem;
        overflow-y: auto;
        overflow-x: hidden;
        min-width: 0;
      }

      .content-header {
        margin-bottom: 2rem;
      }

      .content-header h1 {
        font-size: 2rem;
        color: var(--primary-color);
        margin-bottom: 0.5rem;
      }

      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        margin-bottom: 1.5rem;
      }

      .table-container {
        overflow-x: auto;
      }

      .btn-primary {
        background-color: var(--secondary-color);
        border: none;
      }

      .btn-primary:hover {
        background-color: #5a8bc4;
      }

      .search-box {
        max-width: 400px;
      }

      .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
      }

      .badge-adhd {
        background-color: #c9846a;
        color: white;
      }

      .badge-non-adhd {
        background-color: #6c9bd1;
        color: white;
      }

      .filter-group {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .modal-header {
        background: linear-gradient(135deg, #8fa5b8, #a8c5e4);
        color: white;
      }

      .modal-header .btn-close {
        filter: brightness(0) invert(1);
      }

      .info-section {
        margin-bottom: 1.5rem;
      }

      .info-section h6 {
        color: var(--primary-color);
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-label {
        font-weight: 500;
        color: #6c757d;
      }

      .info-value {
        color: var(--primary-color);
        font-weight: 500;
      }

      .band-bar-modal {
        display: flex;
        align-items: center;
        margin-bottom: 0.8rem;
      }

      .band-label-modal {
        width: 80px;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .band-progress-modal {
        flex: 1;
        height: 24px;
        background: #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        margin: 0 0.8rem;
      }

      .band-progress-bar-modal {
        height: 100%;
        transition: width 0.6s ease;
      }

      .band-value-modal {
        width: 60px;
        text-align: right;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .ratio-item-modal {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.6rem 0.8rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        border-radius: 4px;
      }

      .ratio-name-modal {
        font-size: 0.9rem;
        font-weight: 500;
      }

      .ratio-value-modal {
        font-size: 1rem;
        font-weight: 600;
        color: var(--secondary-color);
      }

      .result-card-modal {
        background: linear-gradient(135deg, #8fa5b8 0%, #a8c5e4 100%);
        color: white;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
        text-align: center;
      }

      .result-card-modal.adhd {
        background: linear-gradient(135deg, #5a6c7d 0%, #4a5568 100%);
      }

      .result-card-modal.non-adhd {
        background: linear-gradient(135deg, #8fa5b8 0%, #7a92a8 100%);
      }

      .result-label-modal {
        font-size: 0.85rem;
        opacity: 0.9;
        margin-bottom: 0.3rem;
      }

      .result-value-modal {
        font-size: 1.8rem;
        font-weight: 700;
      }

      .clickable-row {
        cursor: pointer;
      }

      .clickable-row:hover {
        background-color: #f8f9fa;
      }

      /* Topographic Maps in Modal */
      .topo-section-modal {
        margin-top: 1rem;
      }

      .topo-type-toggle-modal {
        display: flex;
        gap: 0.4rem;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
      }

      .topo-type-btn-modal {
        padding: 0.3rem 0.65rem;
        border: 2px solid var(--secondary-color);
        border-radius: 20px;
        background: white;
        color: var(--secondary-color);
        cursor: pointer;
        font-size: 0.78rem;
        font-weight: 600;
        transition: all 0.2s;
      }

      .topo-type-btn-modal:hover {
        background: rgba(108, 155, 209, 0.1);
      }

      .topo-type-btn-modal.active {
        background: var(--secondary-color);
        color: white;
      }

      .topo-grid-modal {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.5rem;
      }

      .topo-card-modal {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 0.4rem;
        text-align: center;
      }

      .topo-card-modal img {
        width: 100%;
        height: auto;
        border-radius: 4px;
      }

      /* Temporal Biomarkers in Modal */
      .temporal-section-modal {
        margin-top: 1rem;
      }

      .temporal-plot-card-modal {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 0.5rem;
      }

      .temporal-plot-card-modal .plot-header-modal {
        padding: 0.4rem 0.65rem;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        font-weight: 600;
        font-size: 0.82rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .temporal-plot-card-modal .plot-header-modal:hover {
        background: #e9ecef;
      }

      .temporal-plot-card-modal .plot-body-modal {
        padding: 0.4rem;
      }

      .temporal-plot-card-modal .plot-body-modal img {
        width: 100%;
        height: auto;
      }

      .temporal-plot-card-modal .plot-body-modal.collapsed {
        display: none;
      }

      .temporal-summary-grid-modal {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 0.4rem;
        margin-top: 0.5rem;
      }

      .temporal-stat-modal {
        background: #f8f9fa;
        border-radius: 4px;
        padding: 0.35rem 0.5rem;
        font-size: 0.75rem;
      }

      .temporal-stat-modal .stat-label {
        font-weight: 600;
        color: var(--primary-color);
      }

      .temporal-stat-modal .stat-values {
        display: flex;
        gap: 0.4rem;
        color: #4a5568;
      }
    </style>
  </head>

  <body>
    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="navbar-left">
        <button class="navbar-toggle" id="sidebar-toggle">
          <span>☰</span>
        </button>
        <span class="navbar-brand">BayesianADHD</span>
      </div>
      <div style="margin-left: auto; display: flex; align-items: center; gap: 1rem">
        <span style="color: white; font-weight: 500" id="clinician-name"></span>
        <button
          id="logout-btn"
          style="
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid white;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
          "
        >
          Logout
        </button>
      </div>
    </nav>

    <div class="layout-wrapper">
      <!-- Sidebar -->
      <aside class="sidebar collapsed" id="sidebar">
        <nav class="sidebar-nav">
          <ul style="padding: 0; margin: 0">
            <li class="nav-item">
              <a href="/index.html" class="nav-link">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                  <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span>Analysis</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="/subjects.html" class="nav-link">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                <span>Subjects</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="/clinicians.html" class="nav-link">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <span>Clinicians</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="/results.html" class="nav-link active">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                <span>Results</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="/about.html" class="nav-link">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                <span>About</span>
              </a>
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <div class="content-header">
          <h1>Analysis Results</h1>
          <p class="text-muted">View and export analysis results</p>
        </div>

        <!-- Actions Bar -->
        <div class="card">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-8">
                <div class="filter-group">
                  <input
                    type="text"
                    class="form-control search-box"
                    id="search-results"
                    placeholder="Search by subject code..."
                  />
                  <select class="form-select" id="filter-classification" style="max-width: 200px">
                    <option value="">All Classifications</option>
                    <option value="ADHD">ADHD</option>
                    <option value="Non-ADHD">Non-ADHD</option>
                  </select>
                </div>
              </div>
              <div class="col-md-4 text-end">
                <button class="btn btn-primary" id="export-results-btn">Export Results</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Results Table -->
        <div class="card">
          <div class="card-body">
            <div class="table-container">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Subject Code</th>
                    <th>Classification</th>
                    <th>Confidence</th>
                    <th>Clinician</th>
                    <th>Analysis Date</th>
                  </tr>
                </thead>
                <tbody id="results-table-body">
                  <tr>
                    <td colspan="5" class="text-center text-muted">
                      No results found. Perform an analysis to see results here.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Result Details Modal -->
    <div
      class="modal fade"
      id="resultModal"
      tabindex="-1"
      aria-labelledby="resultModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="resultModalLabel">Analysis Result Details</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="modal-body-content">
            <div class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="download-pdf-btn" disabled>
              <span id="pdf-btn-text">Download PDF Report</span>
              <span
                id="pdf-btn-spinner"
                class="spinner-border spinner-border-sm ms-2"
                role="status"
                style="display: none"
              >
                <span class="visually-hidden">Loading...</span>
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Load clinician name and setup logout
      document.addEventListener("DOMContentLoaded", function () {
        const clinicianName = sessionStorage.getItem("clinician_name") || "Clinician";
        document.getElementById("clinician-name").textContent = clinicianName;

        document.getElementById("logout-btn").addEventListener("click", async function () {
          try {
            const response = await fetch("/api/logout", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            });

            if (response.ok) {
              sessionStorage.clear();
              window.location.href = "/login.html";
            } else {
              window.location.href = "/login.html";
            }
          } catch (error) {
            console.error("Error during logout:", error);
            window.location.href = "/login.html";
          }
        });
      });

      // Sidebar toggle
      document.getElementById("sidebar-toggle").addEventListener("click", function () {
        document.getElementById("sidebar").classList.toggle("collapsed");
      });

      let allResults = [];
      let currentResultId = null; // Track currently displayed result for PDF download

      // Load results
      async function loadResults() {
        try {
          const response = await fetch("/api/results");
          allResults = await response.json();

          displayResults(allResults);
        } catch (error) {
          console.error("Error loading results:", error);
          alert("Failed to load results");
        }
      }

      // Display results in table
      function displayResults(results) {
        const tbody = document.getElementById("results-table-body");
        if (results.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-center text-muted">No results found.</td></tr>';
          return;
        }

        tbody.innerHTML = results
          .map((result) => {
            const badgeClass =
              result.predicted_class === "Combined / C (ADHD-C)" ||
              result.predicted_class === "Hyperactive-Impulsive (ADHD-H)" ||
              result.predicted_class === "Inattentive (ADHD-I)"
                ? "badge-adhd"
                : "badge-non-adhd";
            const confidence = (result.confidence_score * 100).toFixed(2);
            const date = new Date(result.inferenced_at).toLocaleString();

            return `
                        <tr class="clickable-row" onclick="viewResult(${result.result_id})">
                            <td>${result.subject_code}</td>
                            <td><span class="badge ${badgeClass}">${result.predicted_class}</span></td>
                            <td>${confidence}%</td>
                            <td>${result.first_name} ${result.last_name}</td>
                            <td>${date}</td>
                        </tr>
                    `;
          })
          .join("");
      }

      // Band colors
      const bandColors = {
        delta: "#9C27B0",
        theta: "#2196F3",
        alpha: "#4CAF50",
        beta: "#FF9800",
        gamma: "#F44336",
      };

      // View result details
      async function viewResult(resultId) {
        const modal = new bootstrap.Modal(document.getElementById("resultModal"));
        const modalBody = document.getElementById("modal-body-content");
        const downloadBtn = document.getElementById("download-pdf-btn");

        // Reset state
        currentResultId = null;
        downloadBtn.disabled = true;

        // Show loading state
        modalBody.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;

        modal.show();

        try {
          const response = await fetch(`/api/results/${resultId}`);
          const data = await response.json();

          if (data.error) {
            modalBody.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
            return;
          }

          // Enable PDF download
          currentResultId = resultId;
          downloadBtn.disabled = false;

          // Build modal content
          const isADHD = data.predicted_class === "ADHD";
          const cardClass = isADHD ? "adhd" : "non-adhd";
          const confidence = (data.confidence_score * 100).toFixed(2);

          // Group band powers by electrode and frequency band
          const bandPowersByElectrode = {};
          const averageBandPowers = {};

          if (data.band_powers && data.band_powers.length > 0) {
            data.band_powers.forEach((bp) => {
              if (!bandPowersByElectrode[bp.electrode]) {
                bandPowersByElectrode[bp.electrode] = {};
              }
              bandPowersByElectrode[bp.electrode][bp.frequency_band] = bp.relative_power;

              // Calculate average across electrodes
              if (!averageBandPowers[bp.frequency_band]) {
                averageBandPowers[bp.frequency_band] = [];
              }
              averageBandPowers[bp.frequency_band].push(bp.relative_power);
            });

            // Average the values
            Object.keys(averageBandPowers).forEach((band) => {
              const values = averageBandPowers[band];
              averageBandPowers[band] = values.reduce((a, b) => a + b, 0) / values.length;
            });
          }

          // Build band power bars
          let bandPowerHTML = "";
          const bandOrder = ["delta", "theta", "alpha", "beta", "gamma"];
          bandOrder.forEach((band) => {
            if (averageBandPowers[band] !== undefined) {
              const percentage = (averageBandPowers[band] * 100).toFixed(1);
              bandPowerHTML += `
                                <div class="band-bar-modal">
                                    <div class="band-label-modal">${
                                      band.charAt(0).toUpperCase() + band.slice(1)
                                    }</div>
                                    <div class="band-progress-modal">
                                        <div class="band-progress-bar-modal" 
                                             style="width: ${percentage}%; background-color: ${
                                               bandColors[band]
                                             };">
                                        </div>
                                    </div>
                                    <div class="band-value-modal">${percentage}%</div>
                                </div>
                            `;
            }
          });

          // Build ratios
          let ratiosHTML = "";
          if (data.ratios && data.ratios.length > 0) {
            data.ratios.forEach((ratio) => {
              const displayName = ratio.ratio_name
                .replace(/_/g, " ")
                .replace(/\b\w/g, (l) => l.toUpperCase());
              ratiosHTML += `
                                <div class="ratio-item-modal">
                                    <span class="ratio-name-modal">${displayName}</span>
                                    <span class="ratio-value-modal">${ratio.ratio_value.toFixed(
                                      3,
                                    )}</span>
                                </div>
                            `;
            });
          } else {
            ratiosHTML = '<p class="text-muted">No ratio data available</p>';
          }

          // Build disclaimers based on recording conditions
          let disclaimersHTML = "";
          const disclaimers = [];
          const sleepNum =
            data.sleep_hours !== undefined && data.sleep_hours !== null
              ? Number(data.sleep_hours)
              : null;
          const isCaffeinated = data.caffeinated === true;
          const isMedicated = data.medicated === true;

          if (sleepNum !== null && !isNaN(sleepNum) && sleepNum < 4) {
            disclaimers.push(
              "The subject has less than 4 hours of sleep which can affect EEG recordings and may affect results.",
            );
          }
          if (isCaffeinated) {
            disclaimers.push(
              "The subject has recent caffeine intake which can alter EEG recordings and may affect analysis.",
            );
          }
          if (isMedicated) {
            disclaimers.push(
              "The subject is medicated which can impact EEG recordings and may affect analysis.",
            );
          }

          // Render Recording Notes header, persistent disclaimer (standalone), and recording-specific yellow alert below
          disclaimersHTML = `
                    <div class="info-section">
                        <h6>Recording Notes</h6>
                        <div id="persistent-disclaimer-modal" style="background:#fff3cd;border:1px solid #e9ecef;padding:0.75rem;border-radius:6px;margin-bottom:0.5rem;">
                            <p style="margin:0"><strong>Important:</strong> This system does not provide a definitive diagnosis. Results are for informational purposes only and must not be used as the sole basis for clinical decisions.</p>
                        </div>
                        ${
                          disclaimers.length > 0
                            ? `
                            <div class="alert-custom" style="background:#fff3cd;border:1px solid #ffeeba;padding:0.75rem;border-radius:6px;">
                                <ul style="margin:0.5rem 0 0 1rem;padding:0">
                                    ${disclaimers
                                      .map((d) => `<li style=\"margin:0.25rem 0\">${d}</li>`)
                                      .join("")}
                                </ul>
                            </div>
                        `
                            : ""
                        }
                    </div>
                `;

          modalBody.innerHTML = `
                        <!-- Two Column Layout -->
                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-md-6">
                                <!-- Prediction Result -->
                                <div class="result-card-modal ${cardClass}">
                                    <div class="result-label-modal">Classification</div>
                                    <div class="result-value-modal">${data.predicted_class}</div>
                                    <div style="margin-top: 0.5rem; font-size: 1rem;">
                                        Confidence: ${confidence}%
                                    </div>
                                </div>
                                
                                <!-- Subject Information -->
                                <div class="info-section">
                                    <h6>Subject Information</h6>
                                    <div class="info-row">
                                        <span class="info-label">Subject Code</span>
                                        <span class="info-value">${data.subject_code}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Age</span>
                                        <span class="info-value">${data.age} years</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Gender</span>
                                        <span class="info-value">${data.gender}</span>
                                    </div>
                                </div>
                                
                                ${
                                  data.clinician_first_name || data.clinician_last_name
                                    ? `
                                <!-- Clinician Information -->
                                <div class="info-section">
                                    <h6>Clinician Information</h6>
                                    <div class="info-row">
                                        <span class="info-label">Name</span>
                                        <span class="info-value">${[
                                          data.clinician_first_name,
                                          data.clinician_middle_name,
                                          data.clinician_last_name,
                                        ]
                                          .filter(Boolean)
                                          .join(" ")}</span>
                                    </div>
                                    ${
                                      data.clinician_occupation
                                        ? `
                                    <div class="info-row">
                                        <span class="info-label">Occupation</span>
                                        <span class="info-value">${data.clinician_occupation}</span>
                                    </div>
                                    `
                                        : ""
                                    }
                                </div>
                                `
                                    : ""
                                }

                                <!-- Recording Information -->
                                <div class="info-section">
                                    <h6>Recording Environment</h6>
                                    <div class="info-row">
                                        <span class="info-label">File Name</span>
                                        <span class="info-value">${data.file_name}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Analysis Date</span>
                                        <span class="info-value">${new Date(
                                          data.inferenced_at,
                                        ).toLocaleString()}</span>
                                    </div>
                                    ${
                                      data.sleep_hours
                                        ? `
                                    <div class="info-row">
                                        <span class="info-label">Sleep Hours</span>
                                        <span class="info-value">${data.sleep_hours} hours</span>
                                    </div>
                                    `
                                        : ""
                                    }
                                    ${
                                      data.food_intake
                                        ? `
                                    <div class="info-row">
                                        <span class="info-label">Food Intake</span>
                                        <span class="info-value">${data.food_intake}</span>
                                    </div>
                                    `
                                        : ""
                                    }
                                    ${
                                      data.caffeinated !== null
                                        ? `
                                    <div class="info-row">
                                        <span class="info-label">Caffeinated</span>
                                        <span class="info-value">${
                                          data.caffeinated ? "Yes" : "No"
                                        }</span>
                                    </div>
                                    `
                                        : ""
                                    }
                                    ${
                                      data.medicated !== null
                                        ? `
                                    <div class="info-row">
                                        <span class="info-label">Medicated</span>
                                        <span class="info-value">${
                                          data.medicated ? "Yes" : "No"
                                        }</span>
                                    </div>
                                    `
                                        : ""
                                    }
                                    ${
                                      data.medication_intake
                                        ? `
                                    <div class="info-row">
                                        <span class="info-label">Medication Details</span>
                                        <span class="info-value">${data.medication_intake}</span>
                                    </div>
                                    `
                                        : ""
                                    }
                                    ${
                                      data.notes
                                        ? `
                                    <div class="info-row">
                                        <span class="info-label">Notes</span>
                                        <span class="info-value">${data.notes}</span>
                                    </div>
                                    `
                                        : ""
                                    }
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div class="col-md-6">
                                <!-- Band Powers -->
                                <div class="info-section">
                                    <h6>Relative Band Power Analysis</h6>
                                    ${
                                      bandPowerHTML ||
                                      '<p class="text-muted">No band power data available</p>'
                                    }
                                </div>

                                <!-- Clinical Ratios -->
                                <div class="info-section">
                                    <h6>Clinical Ratios</h6>
                                    ${ratiosHTML}
                                </div>
                                ${disclaimersHTML}
                            </div>
                        </div>

                        <!-- Full-Width Sections Below -->
                        <!-- Topographic Maps -->
                        <div class="info-section topo-section-modal" id="modal-topo-section">
                            <h6>Spatial Analysis - Scalp Topography</h6>
                            <div class="topo-type-toggle-modal" id="modal-topo-toggle">
                                <button class="topo-type-btn-modal active" data-modal-topo="absolute" onclick="switchModalTopoType('absolute')">Absolute Power</button>
                                <button class="topo-type-btn-modal" data-modal-topo="relative" onclick="switchModalTopoType('relative')">Relative Power</button>
                                <button class="topo-type-btn-modal" data-modal-topo="tbr" onclick="switchModalTopoType('tbr')">TBR</button>
                            </div>
                            <div id="modal-topo-absolute" class="topo-grid-modal"></div>
                            <div id="modal-topo-relative" class="topo-grid-modal" style="display:none;"></div>
                            <div id="modal-topo-tbr" style="display:none;"></div>
                            <div id="modal-topo-loading" class="text-center py-3" style="display:none;">
                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                <span class="ms-2" style="font-size:0.85rem;">Generating topographic maps...</span>
                            </div>
                        </div>

                        <!-- Temporal Biomarkers -->
                        <div class="info-section temporal-section-modal" id="modal-temporal-section">
                            <h6>Temporal Features - Biomarker Evolution</h6>
                            <div id="modal-temporal-plots" style="margin-top:0.75rem;"></div>
                            <div id="modal-temporal-summary"></div>
                            <div id="modal-temporal-loading" class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                <span class="ms-2" style="font-size:0.85rem;">Loading temporal biomarkers...</span>
                            </div>
                        </div>
                    `;

          // Load topographic maps and temporal biomarkers AFTER DOM elements exist
          loadModalTopographicMaps(resultId);
          loadModalTemporalBiomarkers(resultId);
        } catch (error) {
          console.error("Error loading result details:", error);
          modalBody.innerHTML = `<div class="alert alert-danger">Failed to load result details</div>`;
        }
      }

      // Search functionality
      document.getElementById("search-results").addEventListener("input", function (e) {
        const searchTerm = e.target.value.toLowerCase();
        const filtered = allResults.filter((result) =>
          result.subject_code.toLowerCase().includes(searchTerm),
        );
        displayResults(filtered);
      });

      // Filter by classification
      document.getElementById("filter-classification").addEventListener("change", function (e) {
        const classification = e.target.value;
        let filtered = allResults;

        if (classification) {
          filtered = allResults.filter((result) => result.predicted_class === classification);
        }

        displayResults(filtered);
      });

      // Export functionality
      document.getElementById("export-results-btn").addEventListener("click", function () {
        if (allResults.length === 0) {
          alert("No results to export");
          return;
        }

        // Convert to CSV
        const headers = ["Subject Code", "Classification", "Confidence", "Date"];
        const csvContent = [
          headers.join(","),
          ...allResults.map((r) =>
            [
              r.subject_code,
              r.predicted_class,
              (r.confidence_score * 100).toFixed(2) + "%",
              new Date(r.inferenced_at).toLocaleString(),
            ].join(","),
          ),
        ].join("\\n");

        // Download
        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `eeg_results_${new Date().toISOString().split("T")[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
      });

      // PDF Download handler
      document.getElementById("download-pdf-btn").addEventListener("click", async function () {
        if (!currentResultId) {
          alert("No result selected");
          return;
        }

        const btn = this;
        const btnText = document.getElementById("pdf-btn-text");
        const spinner = document.getElementById("pdf-btn-spinner");

        // Show loading state
        btn.disabled = true;
        btnText.textContent = "Generating PDF...";
        spinner.style.display = "inline-block";

        try {
          const response = await fetch(`/api/results/${currentResultId}/pdf`);

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Failed to generate PDF");
          }

          // Get the blob and create download link
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;

          // Extract filename from Content-Disposition header if available
          const contentDisposition = response.headers.get("Content-Disposition");
          let filename = `EEG_Report_${currentResultId}.pdf`;
          if (contentDisposition) {
            const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
            if (filenameMatch) {
              filename = filenameMatch[1];
            }
          }

          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (error) {
          console.error("Error downloading PDF:", error);
          alert("Failed to download PDF: " + error.message);
        } finally {
          // Reset button state
          btn.disabled = false;
          btnText.textContent = "Download PDF Report";
          spinner.style.display = "none";
        }
      });

      // Initialize
      loadResults();
    </script>

    <script>
      // ── Topographic Maps in Modal ──

      async function loadModalTopographicMaps(resultId) {
        const loading = document.getElementById("modal-topo-loading");
        const absGrid = document.getElementById("modal-topo-absolute");
        const relGrid = document.getElementById("modal-topo-relative");
        const tbrDiv = document.getElementById("modal-topo-tbr");

        if (!loading || !absGrid) return;

        loading.style.display = "";
        absGrid.innerHTML = "";
        relGrid.innerHTML = "";
        tbrDiv.innerHTML = "";

        try {
          const response = await fetch(`/api/topographic_maps/${resultId}`);
          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || "Failed to load topographic maps");
          }

          const data = await response.json();
          renderModalTopoMaps(data);
        } catch (error) {
          console.error("Error loading modal topo maps:", error);
          absGrid.innerHTML = `<p class="text-muted" style="font-size:0.85rem;">Could not load topographic maps: ${error.message}</p>`;
        } finally {
          loading.style.display = "none";
        }
      }

      function renderModalTopoMaps(data) {
        const absGrid = document.getElementById("modal-topo-absolute");
        const relGrid = document.getElementById("modal-topo-relative");
        const tbrDiv = document.getElementById("modal-topo-tbr");

        const bandOrder = ["delta", "theta", "alpha", "beta", "gamma"];

        let absHtml = "";
        bandOrder.forEach((band) => {
          const img = data.absolute_power_maps[band];
          if (img) {
            absHtml += `<div class="topo-card-modal"><img src="${img}" alt="${band} absolute" loading="lazy" /></div>`;
          }
        });
        absGrid.innerHTML = absHtml || '<p class="text-muted">No data</p>';

        let relHtml = "";
        bandOrder.forEach((band) => {
          const img = data.relative_power_maps[band];
          if (img) {
            relHtml += `<div class="topo-card-modal"><img src="${img}" alt="${band} relative" loading="lazy" /></div>`;
          }
        });
        relGrid.innerHTML = relHtml || '<p class="text-muted">No data</p>';

        if (data.tbr_map) {
          tbrDiv.innerHTML = `<div class="topo-grid-modal" style="max-width:240px;"><div class="topo-card-modal"><img src="${data.tbr_map}" alt="TBR" loading="lazy" /></div></div>`;
        } else {
          tbrDiv.innerHTML = '<p class="text-muted">No TBR map</p>';
        }
      }

      function switchModalTopoType(type) {
        ["absolute", "relative", "tbr"].forEach((t) => {
          const el = document.getElementById(`modal-topo-${t}`);
          const btn = document.querySelector(`[data-modal-topo="${t}"]`);
          if (t === type) {
            el.style.display = "";
            btn.classList.add("active");
          } else {
            el.style.display = "none";
            btn.classList.remove("active");
          }
        });
      }

      // ── Temporal Biomarkers in Modal ──

      async function loadModalTemporalBiomarkers(resultId) {
        const loading = document.getElementById("modal-temporal-loading");
        const plotsContainer = document.getElementById("modal-temporal-plots");
        const summaryContainer = document.getElementById("modal-temporal-summary");

        if (!loading || !plotsContainer) return;

        loading.style.display = "";
        plotsContainer.innerHTML = "";
        summaryContainer.innerHTML = "";

        try {
          const response = await fetch(`/api/temporal_biomarkers/${resultId}`);
          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || "Failed to load temporal biomarkers");
          }

          const data = await response.json();
          renderModalTemporalPlots(data.plots, plotsContainer);
          renderModalTemporalSummary(data.summary, summaryContainer);
        } catch (error) {
          console.error("Error loading temporal biomarkers:", error);
          plotsContainer.innerHTML = `<p class="text-muted" style="font-size:0.85rem;">Could not load temporal biomarkers: ${error.message}</p>`;
        } finally {
          loading.style.display = "none";
        }
      }

      function renderModalTemporalPlots(plots, container) {
        let html = "";
        plots.forEach((plot, index) => {
          const collapsed = index > 0 ? "collapsed" : "";
          const chevron = index > 0 ? "&#9654;" : "&#9660;";
          html += `
            <div class="temporal-plot-card-modal">
              <div class="plot-header-modal" onclick="toggleModalTemporalPlot(this)">
                <span>${plot.group}</span>
                <span class="chevron">${chevron}</span>
              </div>
              <div class="plot-body-modal ${collapsed}">
                <img src="${plot.image}" alt="${plot.group}" loading="lazy" />
              </div>
            </div>`;
        });
        container.innerHTML = html || '<p class="text-muted">No plots</p>';
      }

      function toggleModalTemporalPlot(header) {
        const body = header.nextElementSibling;
        const chevron = header.querySelector(".chevron");
        if (body.classList.contains("collapsed")) {
          body.classList.remove("collapsed");
          chevron.innerHTML = "&#9660;";
        } else {
          body.classList.add("collapsed");
          chevron.innerHTML = "&#9654;";
        }
      }

      const biomarkerLabelsModal = {
        theta_beta_ratio: "Theta/Beta",
        theta_alpha_ratio: "Theta/Alpha",
        alpha_theta_ratio: "Alpha/Theta",
        alpha_beta_ratio: "Alpha/Beta",
        delta_theta_ratio: "Delta/Theta",
        low_beta_high_beta_ratio: "Low Beta/High Beta",
        combined_ratio: "Combined (T+B)/(A+G)",
        peak_alpha_frequency: "Peak Alpha Freq (Hz)",
        spectral_entropy: "Spectral Entropy",
        spectral_edge_freq_90: "Spectral Edge 90% (Hz)",
        hjorth_activity: "Activity",
        hjorth_mobility: "Mobility",
        hjorth_complexity: "Complexity",
        frontal_theta_power: "Frontal Theta Power",
        frontal_theta_beta_ratio: "Frontal Theta/Beta",
        central_theta_beta_ratio: "Central Theta/Beta",
        alpha_asymmetry: "Alpha Asymmetry (L−R)/(L+R)",
        theta_asymmetry: "Theta Asymmetry (L−R)/(L+R)",
        frontal_parietal_theta_ratio: "Frontal/Parietal Theta",
        frontal_parietal_alpha_ratio: "Frontal/Parietal Alpha",
      };

      function renderModalTemporalSummary(summary, container) {
        if (!summary || Object.keys(summary).length === 0) {
          container.innerHTML = "";
          return;
        }
        let html =
          '<h6 style="font-weight:600; margin-top:0.75rem; font-size:0.9rem;">Biomarker Summary</h6>';
        html += '<div class="temporal-summary-grid-modal">';
        Object.entries(summary).forEach(([key, stats]) => {
          const label = biomarkerLabelsModal[key] || key;
          html += `
            <div class="temporal-stat-modal">
              <div class="stat-label">${label}</div>
              <div class="stat-values">
                <span title="Mean">&mu;=${stats.mean.toFixed(3)}</span>
                <span title="Std Dev">&sigma;=${stats.std.toFixed(3)}</span>
              </div>
            </div>`;
        });
        html += "</div>";
        container.innerHTML = html;
      }
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
